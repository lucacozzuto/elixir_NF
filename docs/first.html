<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>First Day &mdash; Reproducible research and data analysis using Nextflow pipelines  documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="prev" title="About the course" href="about.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index.html" class="icon icon-home"> Reproducible research and data analysis using Nextflow pipelines
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="about.html">About the course</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">First Day</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#introduction-to-linux-containers">Introduction to Linux containers.</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#what-are-containers">What are containers?</a></li>
<li class="toctree-l3"><a class="reference internal" href="#virtual-machines-or-containers">Virtual machines or containers ?</a></li>
<li class="toctree-l3"><a class="reference internal" href="#virtualisation">Virtualisation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#containerisation-aka-lightweight-virtualisation">Containerisation (aka lightweight virtualisation)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#virtual-machines-vs-containers">Virtual machines vs containers</a></li>
<li class="toctree-l3"><a class="reference internal" href="#history-of-containers">History of containers</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#introduction-to-docker">Introduction to Docker</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#what-is-docker">What is Docker?</a></li>
<li class="toctree-l3"><a class="reference internal" href="#docker-components">Docker components</a></li>
<li class="toctree-l3"><a class="reference internal" href="#images-versus-containers">Images versus containers</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#introduction-to-singularity">Introduction to Singularity</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#singularity-architecture">Singularity architecture</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#container-registries">Container registries</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#running-and-executing-containers">Running and executing containers</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#introduction-to-nextflow">Introduction to Nextflow</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#what-is-nextflow">What is Nextflow?</a></li>
<li class="toctree-l3"><a class="reference internal" href="#what-is-nextflow-for">What is Nextflow for?</a></li>
<li class="toctree-l3"><a class="reference internal" href="#main-advantages">Main advantages</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#workflow-structure">Workflow structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="#installation">Installation</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Reproducible research and data analysis using Nextflow pipelines</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
      <li>First Day</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="first-day">
<span id="first-page"></span><h1>First Day<a class="headerlink" href="#first-day" title="Permalink to this headline"></a></h1>
<section id="introduction-to-linux-containers">
<h2>Introduction to Linux containers.<a class="headerlink" href="#introduction-to-linux-containers" title="Permalink to this headline"></a></h2>
<section id="what-are-containers">
<h3>What are containers?<a class="headerlink" href="#what-are-containers" title="Permalink to this headline"></a></h3>
<a class="reference internal image-reference" href="https://www.synopsys.com/blogs/software-security/wp-content/uploads/2018/04/containers-rsa.jpg"><img alt="https://www.synopsys.com/blogs/software-security/wp-content/uploads/2018/04/containers-rsa.jpg" src="https://www.synopsys.com/blogs/software-security/wp-content/uploads/2018/04/containers-rsa.jpg" style="width: 700px;" /></a>
<p>A Container can be seen as a <strong>minimal virtual environment</strong> that can be used in any Linux-compatible machine (and beyond).</p>
<p>Using containers is time- and resource-saving as they allow:</p>
<ul class="simple">
<li><p>Controlling for software installation and dependencies.</p></li>
<li><p>Reproducibility of the analysis.</p></li>
</ul>
<p>Containers allow us to use <strong>exactly the same versions of the tools</strong>.</p>
</section>
<section id="virtual-machines-or-containers">
<h3>Virtual machines or containers ?<a class="headerlink" href="#virtual-machines-or-containers" title="Permalink to this headline"></a></h3>
<table class="docutils align-default">
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Virtualisation</p></th>
<th class="head"><p>Containerisation (aka lightweight virtualisation)</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Abstraction of physical hardware</p></td>
<td><p>Abstraction of application layer</p></td>
</tr>
<tr class="row-odd"><td><p>Depends on hypervisor (software)</p></td>
<td><p>Depends on host kernel (OS)</p></td>
</tr>
<tr class="row-even"><td><p>Do not confuse with hardware emulator</p></td>
<td><p>Application and dependencies bundled all together</p></td>
</tr>
<tr class="row-odd"><td><p>Enable virtual machines</p></td>
<td><p>Every virtual machine with an OS (Operating System)</p></td>
</tr>
</tbody>
</table>
</section>
<section id="virtualisation">
<h3>Virtualisation<a class="headerlink" href="#virtualisation" title="Permalink to this headline"></a></h3>
<ul class="simple">
<li><p>Abstraction of physical hardware</p></li>
<li><p>Depends on hypervisor (software)</p></li>
<li><p>Do not confuse with hardware emulator</p></li>
<li><dl class="simple">
<dt>Enable virtual machines:</dt><dd><ul>
<li><p>Every virtual machine with an OS (Operating System)</p></li>
</ul>
</dd>
</dl>
</li>
</ul>
</section>
<section id="containerisation-aka-lightweight-virtualisation">
<h3>Containerisation (aka lightweight virtualisation)<a class="headerlink" href="#containerisation-aka-lightweight-virtualisation" title="Permalink to this headline"></a></h3>
<ul class="simple">
<li><p>Abstraction of application layer</p></li>
<li><p>Depends on host kernel (OS)</p></li>
<li><p>Application and dependencies bundled all together</p></li>
</ul>
</section>
<section id="virtual-machines-vs-containers">
<h3>Virtual machines vs containers<a class="headerlink" href="#virtual-machines-vs-containers" title="Permalink to this headline"></a></h3>
<a class="reference internal image-reference" href="https://raw.githubusercontent.com/collabnix/dockerlabs/master/beginners/docker/images/vm-docker5.png"><img alt="https://raw.githubusercontent.com/collabnix/dockerlabs/master/beginners/docker/images/vm-docker5.png" src="https://raw.githubusercontent.com/collabnix/dockerlabs/master/beginners/docker/images/vm-docker5.png" style="width: 800px;" /></a>
<p><a class="reference external" href="https://dockerlabs.collabnix.com/beginners/difference-docker-vm.html">Source</a></p>
<p><strong>Pros and cons</strong></p>
<table class="docutils align-default">
<colgroup>
<col style="width: 4%" />
<col style="width: 46%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>ADV</p></th>
<th class="head"><p>Virtualisation</p></th>
<th class="head"><p>Containerisation</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>PROS.</p></td>
<td><ul class="simple">
<li><p>Very similar to a full OS.</p></li>
<li><p>High OS diversity</p></li>
</ul>
</td>
<td><ul class="simple">
<li><p>No need of full OS installation (less space).</p></li>
<li><p>Better portability</p></li>
<li><p>Faster than virtual machines.</p></li>
<li><p>Easier automation.</p></li>
<li><p>Easier distribution of recipes.</p></li>
<li><p>Better portability.</p></li>
</ul>
</td>
</tr>
<tr class="row-odd"><td><p>CONS.</p></td>
<td><ul class="simple">
<li><p>Need more space and resources.</p></li>
<li><p>Slower than containers.</p></li>
<li><p>Not that good automation.</p></li>
</ul>
</td>
<td><ul class="simple">
<li><p>Some cases might not be exactly the same as a full OS.</p></li>
<li><p>Still less OS diversity, even with current solutions</p></li>
</ul>
</td>
</tr>
</tbody>
</table>
</section>
<section id="history-of-containers">
<h3>History of containers<a class="headerlink" href="#history-of-containers" title="Permalink to this headline"></a></h3>
<p><strong>chroot</strong></p>
<ul class="simple">
<li><p>chroot jail (BSD jail): first concept in 1979</p></li>
<li><p>Notable use in SSH and FTP servers</p></li>
<li><p>Honeypot, recovery of systems, etc.</p></li>
</ul>
<a class="reference internal image-reference" href="https://sysopsio.files.wordpress.com/2016/09/linux-chroot-jail.png"><img alt="https://sysopsio.files.wordpress.com/2016/09/linux-chroot-jail.png" src="https://sysopsio.files.wordpress.com/2016/09/linux-chroot-jail.png" style="width: 550px;" /></a>
<p><strong>Additions in Linux kernel</strong></p>
<ul class="simple">
<li><p>First version: 2008</p></li>
<li><dl class="simple">
<dt>cgroups (control groups), before “process containers”</dt><dd><ul>
<li><p>isolate resource usage (CPU, memory, disk I/O, network, etc.) of a collection of processes</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>Linux namespaces</dt><dd><ul>
<li><p>one set of kernel resources restrict to one set of processes</p></li>
</ul>
</dd>
</dl>
</li>
</ul>
<a class="reference internal image-reference" href="../_images/linux-vs-docker-comparison-architecture-docker-lxc.png"><img alt="../_images/linux-vs-docker-comparison-architecture-docker-lxc.png" src="../_images/linux-vs-docker-comparison-architecture-docker-lxc.png" style="width: 600px;" /></a>
</section>
</section>
<section id="introduction-to-docker">
<h2>Introduction to Docker<a class="headerlink" href="#introduction-to-docker" title="Permalink to this headline"></a></h2>
<a class="reference internal image-reference" href="https://connpass-tokyo.s3.amazonaws.com/thumbs/80/52/80521f18aec0945dfedbb471dad6aa1a.png"><img alt="https://connpass-tokyo.s3.amazonaws.com/thumbs/80/52/80521f18aec0945dfedbb471dad6aa1a.png" src="https://connpass-tokyo.s3.amazonaws.com/thumbs/80/52/80521f18aec0945dfedbb471dad6aa1a.png" style="width: 400px;" /></a>
<section id="what-is-docker">
<h3>What is Docker?<a class="headerlink" href="#what-is-docker" title="Permalink to this headline"></a></h3>
<ul class="simple">
<li><p>Platform for developing, shipping and running applications.</p></li>
<li><p>Infrastructure as application / code.</p></li>
<li><p>First version: 2013.</p></li>
<li><p>Company: originally dotCloud (2010), later named Docker.</p></li>
<li><p>Established [Open Container Initiative](<a class="reference external" href="https://www.opencontainers.org/">https://www.opencontainers.org/</a>).</p></li>
</ul>
<p>As a software:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://www.docker.com/products/container-runtime">Docker Community Edition</a>.</p></li>
<li><p>Docker Enterprise Edition.</p></li>
</ul>
<p>There is an increasing number of alternative container technologies and providers. Many of them are actually based on software components originally from the Docker stack and they normally try to address some specific use cases or weakpoints. As a example, <strong>Singularity</strong>, that we introduce later in this couse, is focused in HPC environments. Another case, <strong>Podman</strong>, keeps a high functional compatibility with Docker but with a different focus on technology (not keeping a daemon) and permissions.</p>
</section>
<section id="docker-components">
<h3>Docker components<a class="headerlink" href="#docker-components" title="Permalink to this headline"></a></h3>
<a class="reference internal image-reference" href="http://apachebooster.com/kb/wp-content/uploads/2017/09/docker-architecture.png"><img alt="http://apachebooster.com/kb/wp-content/uploads/2017/09/docker-architecture.png" src="http://apachebooster.com/kb/wp-content/uploads/2017/09/docker-architecture.png" style="width: 700px;" /></a>
<ul class="simple">
<li><p>Read-only templates.</p></li>
<li><p>Containers are run from them.</p></li>
<li><p>Images are not run.</p></li>
<li><p>Images have several layers.</p></li>
</ul>
<a class="reference internal image-reference" href="https://i.stack.imgur.com/vGuay.png"><img alt="https://i.stack.imgur.com/vGuay.png" src="https://i.stack.imgur.com/vGuay.png" style="width: 700px;" /></a>
</section>
<section id="images-versus-containers">
<h3>Images versus containers<a class="headerlink" href="#images-versus-containers" title="Permalink to this headline"></a></h3>
<ul class="simple">
<li><p><strong>Image</strong>: A set of layers, read-only templates, inert.</p></li>
<li><p>An instance of an image is called a <strong>container</strong>.</p></li>
</ul>
<p>When you start an image, you have a running container of this image. You can have many running containers of the same image.</p>
<p><em>“The image is the recipe, the container is the cake; you can make as many cakes as you like with a given recipe.”</em></p>
<p><a class="reference external" href="https://stackoverflow.com/questions/23735149/what-is-the-difference-between-a-docker-image-and-a-container">https://stackoverflow.com/questions/23735149/what-is-the-difference-between-a-docker-image-and-a-container</a></p>
<a class="reference internal image-reference" href="../_images/singularity_logo.svg"><img alt="../_images/singularity_logo.svg" src="../_images/singularity_logo.svg" width="300" /></a>
</section>
</section>
<section id="introduction-to-singularity">
<h2>Introduction to Singularity<a class="headerlink" href="#introduction-to-singularity" title="Permalink to this headline"></a></h2>
<ul class="simple">
<li><dl class="simple">
<dt>Focus:</dt><dd><ul>
<li><p>Reproducibility to scientific computing and the high-performance computing (HPC) world.</p></li>
</ul>
</dd>
</dl>
</li>
<li><p>Origin: Lawrence Berkeley National Laboratory. Later spin-off: Sylabs</p></li>
<li><p>Version 1.0 -&gt; 2016</p></li>
<li><p>More information: <a class="reference external" href="https://en.wikipedia.org/wiki/Singularity_(software)">https://en.wikipedia.org/wiki/Singularity_(software)</a></p></li>
</ul>
<section id="singularity-architecture">
<h3>Singularity architecture<a class="headerlink" href="#singularity-architecture" title="Permalink to this headline"></a></h3>
<a class="reference internal image-reference" href="../_images/singularity_architecture.png"><img alt="../_images/singularity_architecture.png" src="../_images/singularity_architecture.png" style="width: 800px;" /></a>
<table class="docutils align-default">
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Strengths</p></th>
<th class="head"><p>Weaknesses</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>No dependency of a daemon</p></td>
<td><p>At the time of writing only good support in Linux</p></td>
</tr>
<tr class="row-odd"><td><p>Can be run as a simple user</p></td>
<td><p>Mac experimental. Desktop edition. Only running</p></td>
</tr>
<tr class="row-even"><td><p>Avoids permission headaches and hacks</p></td>
<td><p>For some features you need root account (or sudo)</p></td>
</tr>
<tr class="row-odd"><td><p>Image/container is a file (or directory)</p></td>
<td></td>
</tr>
<tr class="row-even"><td><p>More easily portable</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>Two types of images: Read-only (production)</p></td>
<td></td>
</tr>
<tr class="row-even"><td><p>Writable (development, via sandbox)</p></td>
<td></td>
</tr>
</tbody>
</table>
<p><strong>Trivia</strong></p>
<p>Nowadays, there may be some confusion since there are two projects:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://singularity.hpcng.org/">HPCng Singularity</a></p></li>
<li><p><a class="reference external" href="https://sylabs.io/singularity/">Sylabs Singularity</a></p></li>
</ul>
<p>They “forked” not long ago. So far they share most of the codebase, but eventually this might be different, and software might have different functionality.</p>
</section>
</section>
<section id="container-registries">
<h2>Container registries<a class="headerlink" href="#container-registries" title="Permalink to this headline"></a></h2>
<p>Container images, normally different versions of them, are stored in container repositories.</p>
<p>These repositories can be browser or discovered within, normally public, container registries.</p>
<p><strong>Docker Hub</strong></p>
<p>It is the first and most popular public container registry (which provides also private repositories).</p>
<ul class="simple">
<li><p><a class="reference external" href="https://hub.docker.com">Docker Hub</a></p></li>
</ul>
<p>Example:</p>
<p><a class="reference external" href="https://hub.docker.com/r/biocontainers/fastqc">https://hub.docker.com/r/biocontainers/fastqc</a></p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">singularity build fastqc-0.11.9_cv7.sif docker://biocontainers/fastqc:v0.11.9_cv7</span>
</pre></div>
</div>
<p><strong>Biocontainers</strong></p>
<ul class="simple">
<li><p><a class="reference external" href="https://biocontainers.pro">Biocontainers</a></p></li>
</ul>
<p>Website gathering Bioinformatics focused container images from different registries.</p>
<p>Originally Docker Hub was used, but now other registries are preferred.</p>
<p>Example: <a class="reference external" href="https://biocontainers.pro/tools/fastqc">https://biocontainers.pro/tools/fastqc</a></p>
<p><em>Via quay.io</em></p>
<p><a class="reference external" href="https://quay.io/repository/biocontainers/fastqc)">https://quay.io/repository/biocontainers/fastqc</a></p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">singularity build fastqc-0.11.9.sif docker://quay.io/biocontainers/fastqc:0.11.9--0</span>
</pre></div>
</div>
<p><em>Via Galaxy project prebuilt images</em></p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">singularity pull --name fastqc-0.11.9.sif https://depot.galaxyproject.org/singularity/fastqc:0.11.9--0</span>
</pre></div>
</div>
<p>Galaxy project provides all Bioinformatics software from the BioContainers initiative as Singularity prebuilt images. If download and conversion time of images is an issue, this might be the best option for those working in the biomedical field.</p>
<section id="running-and-executing-containers">
<h3>Running and executing containers<a class="headerlink" href="#running-and-executing-containers" title="Permalink to this headline"></a></h3>
<p>Once we have some image files (or directories) ready, we can run processes.</p>
<p><strong>Singularity shell</strong></p>
<p>The straight-forward exploratory approach is equivalent to <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">run</span> <span class="pre">-ti</span> <span class="pre">biocontainers/fastqc:v0.11.9_cv7</span> <span class="pre">/bin/shell</span></code> but with a more handy syntax.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">singularity shell fastqc-0.11.9.sif</span>
</pre></div>
</div>
<p>Move around the directories and notice how the isolation approach is different in comparison to Docker. You can access most of the host filesystem.</p>
<p><strong>Singularity exec</strong></p>
<p>That is the most common way to execute Singularity (equivalent to <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">exec</span></code>). That would be the normal approach in a HPC environment.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">singularity exec fastqc-0.11.9.sif fastqc</span>
</pre></div>
</div>
<p>Test a processing of a file from <em>testdata</em> directory:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">singularity exec fastqc-0.11.9_cv7.sif fastqc B7_input_s_chr19.fastq.gz</span>
</pre></div>
</div>
<p><strong>Singularity run</strong></p>
<p>This executes runscript from recipe definition (equivalent to <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">run</span></code>). Not so common for HPC uses. More common for instances (servers).</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">singularity run fastqc-0.11.9.sif</span>
</pre></div>
</div>
<p><strong>Environment control</strong></p>
<p>By default Singularity inherits a profile environment (e.g., PATH environment variable). This may be convenient in some circumstances, but it can also lead to unexpected problems when your own environment clashes with the default one from the image.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">singularity shell -e fastqc-0.11.9.sif</span>
<span class="go">singularity exec -e fastqc-0.11.9.sif fastqc</span>
<span class="go">singularity run -e fastqc-0.11.9.sif</span>
</pre></div>
</div>
<p>Compare <code class="docutils literal notranslate"><span class="pre">env</span></code> command with and without -e modifier.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">singularity exec fastqc-0.11.9.sif env</span>
<span class="go">singularity exec -e fastqc-0.11.9.sif env</span>
</pre></div>
</div>
<p><strong>Exercise</strong></p>
<ul class="simple">
<li><dl class="simple">
<dt>Generate a Singularity image of the last <em>samtools</em> version</dt><dd><ul>
<li><p>Consider and compare different registry sources</p></li>
</ul>
</dd>
</dl>
</li>
<li><p>Explore the inside contents of the image</p></li>
<li><p>Execute in different ways <code class="docutils literal notranslate"><span class="pre">samtools</span></code> program (e. g., using <em>fqidx</em> option)</p></li>
</ul>
</section>
</section>
<section id="introduction-to-nextflow">
<h2>Introduction to Nextflow<a class="headerlink" href="#introduction-to-nextflow" title="Permalink to this headline"></a></h2>
<p>DSL for data-driven computational pipelines. <a class="reference external" href="https://www.nextflow.io">www.nextflow.io</a>.</p>
<a class="reference internal image-reference" href="../_images/nextflow_logo_deep.png"><img alt="../_images/nextflow_logo_deep.png" src="../_images/nextflow_logo_deep.png" style="width: 400px;" /></a>
<section id="what-is-nextflow">
<h3>What is Nextflow?<a class="headerlink" href="#what-is-nextflow" title="Permalink to this headline"></a></h3>
<a class="reference internal image-reference" href="../_images/nextf_groovy.png"><img alt="../_images/nextf_groovy.png" src="../_images/nextf_groovy.png" style="width: 600px;" /></a>
<p><a class="reference external" href="https://www.nextflow.io">Nextflow</a> is a domain specific language (DSL) for workflow orchestration that stems from <a class="reference external" href="https://groovy-lang.org/">Groovy</a>. It enables scalable and reproducible workflows using software containers.
It was developed at the <a class="reference external" href="www.crg.eu">CRG</a> in the Lab of Cedric Notredame by <a class="reference external" href="https://github.com/pditommaso">Paolo Di Tommaso</a>.
The Nextflow documentation is <a class="reference external" href="https://www.nextflow.io/docs/latest/">available here</a> and you can ask help to the community using their <a class="reference external" href="https://gitter.im/nextflow-io/nextflow">gitter channel</a></p>
<p>In 2020, Nextflow has been upgraded from DSL1 version to DSL2. In this course we will use exclusively DSL2.</p>
</section>
<section id="what-is-nextflow-for">
<h3>What is Nextflow for?<a class="headerlink" href="#what-is-nextflow-for" title="Permalink to this headline"></a></h3>
<p>It is for making pipelines without caring about parallelization, dependencies, intermediate file names, data structures, handling exceptions, resuming executions, etc.</p>
<p>It was published in <a class="reference external" href="https://pubmed.ncbi.nlm.nih.gov/28398311/">Nature Biotechnology in 2017</a>.</p>
<a class="reference internal image-reference" href="../_images/NF_pub.png"><img alt="../_images/NF_pub.png" src="../_images/NF_pub.png" style="width: 600px;" /></a>
<p>There is a growing number of <a class="reference external" href="https://pubmed.ncbi.nlm.nih.gov/?term=nextflow&amp;timeline=expanded&amp;sort=pubdate&amp;sort_order=asc">PubMed</a> publications citing Nextflow.</p>
<a class="reference internal image-reference" href="../_images/NF_mentioning.png"><img alt="../_images/NF_mentioning.png" src="../_images/NF_mentioning.png" style="width: 600px;" /></a>
<p>A curated list of <a class="reference external" href="https://github.com/nextflow-io/awesome-nextflow">Nextflow pipelines</a>.</p>
<p>Many pipelines written collaboratively are provided by the <a class="reference external" href="https://nf-co.re/pipelines">NF-core</a> project.</p>
<p>Some pipelines written in Nextflow have been used for the SARS-Cov-2 analysis, for example:</p>
<ul class="simple">
<li><p>The <a class="reference external" href="https://artic.network/ncov-2019">artic Network</a> pipeline <a class="reference external" href="https://github.com/connor-lab/ncov2019-artic-nf">ncov2019-artic-nf</a>.</p></li>
<li><p>The <a class="reference external" href="https://covid19beacon.crg.eu/info">CRG / EGA viral Beacon</a> pipeline <a class="reference external" href="https://github.com/biocorecrg/master_of_pores">Master of Pores</a>.</p></li>
<li><p>The nf-core pipeline <a class="reference external" href="https://nf-co.re/viralrecon">viralrecon</a>.</p></li>
</ul>
</section>
<section id="main-advantages">
<h3>Main advantages<a class="headerlink" href="#main-advantages" title="Permalink to this headline"></a></h3>
<ul class="simple">
<li><p><strong>Fast prototyping</strong></p></li>
</ul>
<p>You can quickly write a small pipeline that can be <strong>expanded incrementally</strong>.
<strong>Each task is independent</strong> and can be easily added to other. You can reuse scripts without re-writing or adapting them.</p>
<ul class="simple">
<li><p><strong>Reproducibility</strong></p></li>
</ul>
<p>Nextflow supports <strong>Docker</strong> and <strong>Singularity</strong> containers technology. Their use will make the pipelines reproducible in any Unix environment. Nextflow is integrated with <strong>GitHub code sharing platform</strong>, so you can call directly a specific version of a pipeline from a repository, download and use it on-the-fly.</p>
<ul class="simple">
<li><p><strong>Portability</strong></p></li>
</ul>
<p>Nextflow can be executed on <strong>multiple platforms</strong> without modifiying the code. It supports several schedulers such as <strong>SGE, LSF, SLURM, PBS, HTCondor</strong> and cloud platforms like <strong>Kubernetes, Amazon AWS, Google Cloud</strong>.</p>
<a class="reference internal image-reference" href="../_images/executors.png"><img alt="../_images/executors.png" src="../_images/executors.png" style="width: 600px;" /></a>
<ul class="simple">
<li><p><strong>Scalability</strong></p></li>
</ul>
<p>Nextflow is based on the <strong>dataflow programming model</strong> which simplifies writing complex pipelines.
The tool takes care of <strong>parallelizing the processes</strong> without additionally written code.
The resulting applications are inherently parallel and can scale-up or scale-out transparently; there is no need to adapt them to a specific platform architecture.</p>
<ul class="simple">
<li><p><strong>Resumable, thanks to continuous checkpoints</strong></p></li>
</ul>
<p>All the intermediate results produced during the pipeline execution are automatically tracked.
For each process <strong>a temporary folder is created and is cached (or not) once resuming an execution</strong>.</p>
</section>
</section>
<section id="workflow-structure">
<h2>Workflow structure<a class="headerlink" href="#workflow-structure" title="Permalink to this headline"></a></h2>
<p>The workflows can be represented as graphs where the nodes are the <strong>processes</strong> and the edges are the <strong>channels</strong>.
The <strong>processes</strong> are blocks of code that can be executed - such as scripts or programs - while the <strong>channels</strong> are asynchronous queues able to <strong>connect processes among them via input / output</strong>.</p>
<a class="reference internal image-reference" href="../_images/wf_example.png"><img alt="../_images/wf_example.png" src="../_images/wf_example.png" style="width: 600px;" /></a>
<p>Processes are independent from each another and can be run in parallel, depending on the number of elements in a channel.
In the previous example, processes <strong>A</strong>, <strong>B</strong> and <strong>C</strong> can be run in parallel and only when they <strong>ALL</strong> end the process <strong>D</strong> is triggered.</p>
</section>
<section id="installation">
<h2>Installation<a class="headerlink" href="#installation" title="Permalink to this headline"></a></h2>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Nextflow is already installed on the machines provided for this course.
You need at least the Java version 8 for the Nextflow installation.</p>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>You can check the version fo java by typing:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">java</span> <span class="o">-</span><span class="n">version</span>
</pre></div>
</div>
</div>
<p>Then we can install Nextflow with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">curl</span> <span class="o">-</span><span class="n">s</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">get</span><span class="o">.</span><span class="n">nextflow</span><span class="o">.</span><span class="n">io</span> <span class="o">|</span> <span class="n">bash</span>
</pre></div>
</div>
<p>This will create the <code class="docutils literal notranslate"><span class="pre">nextflow</span></code> executable that can be moved, for example, to <code class="docutils literal notranslate"><span class="pre">/usr/local/bin</span></code>.</p>
<p>We can test that the installation was successful with:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">nextflow run hello</span>

<span class="go">N E X T F L O W  ~  version 20.07.1</span>
<span class="go">Pulling nextflow-io/hello ...</span>
<span class="go">downloaded from https://github.com/nextflow-io/hello.git</span>
<span class="go">Launching `nextflow-io/hello` [peaceful_brahmagupta] - revision: 96eb04d6a4 [master]</span>
<span class="go">executor &gt;  local (4)</span>
<span class="go">[d7/d053b5] process &gt; sayHello (4) [100%] 4 of 4 ✔</span>
<span class="go">Ciao world!</span>
<span class="go">Bonjour world!</span>
<span class="go">Hello world!</span>
<span class="go">Hola world!</span>
</pre></div>
</div>
<p>This command downloads and runs the pipeline <code class="docutils literal notranslate"><span class="pre">hello</span></code>.</p>
<p>We can now launch a test pipeline:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">nextflow run nextflow-io/rnaseq-nf -with-singularity</span>
</pre></div>
</div>
<p>This command will automatically pull the pipeline and the required test data from the <a class="reference external" href="https://github.com/nextflow-io/rnatoy">github repository</a>
The command <code class="docutils literal notranslate"><span class="pre">-with-singularity</span></code> will automatically trigger the download of the image <code class="docutils literal notranslate"><span class="pre">nextflow/rnatoy:1.3</span></code> from DockerHub and convert it on-the-fly into a singularity image that will be used for running each step of the pipeline.
The pipeline can also recognize the queue system which is used on the machine where it is launched. In the following examples, I launched the same pipeline both on the CRG high performance computing (HPC) cluster and on my MacBook:</p>
<p>The result from CRG HPC:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">nextflow run nextflow-io/rnaseq-nf -with-singularity</span>

<span class="go">N E X T F L O W  ~  version 21.04.3</span>
<span class="go">Pulling nextflow-io/rnaseq-nf ...</span>
<span class="go">downloaded from https://github.com/nextflow-io/rnaseq-nf.git</span>
<span class="go">Launching `nextflow-io/rnaseq-nf` [serene_wing] - revision: 83bdb3199b [master]</span>
<span class="go">R N A S E Q - N F   P I P E L I N E</span>
<span class="go"> ===================================</span>
<span class="go">transcriptome: /users/bi/lcozzuto/.nextflow/assets/nextflow-io/rnaseq-nf/data/ggal/ggal_1_48850000_49020000.Ggal71.500bpflank.fa</span>
<span class="go">reads        : /users/bi/lcozzuto/.nextflow/assets/nextflow-io/rnaseq-nf/data/ggal/*_{1,2}.fq</span>
<span class="go">outdir       : results</span>

<span class="go">[-        ] process &gt; RNASEQ:INDEX  -</span>
<span class="go">[-        ] process &gt; RNASEQ:FASTQC -</span>
<span class="go">executor &gt;  crg (6)</span>
<span class="go">[cc/dd76f0] process &gt; RNASEQ:INDEX (ggal_1_48850000_49020000) [100%] 1 of 1 ✔</span>
<span class="go">[7d/7a96f2] process &gt; RNASEQ:FASTQC (FASTQC on ggal_liver)    [100%] 2 of 2 ✔</span>
<span class="go">[ab/ac8558] process &gt; RNASEQ:QUANT (ggal_gut)                 [100%] 2 of 2 ✔</span>
<span class="go">[a0/452d3f] process &gt; MULTIQC                                 [100%] 1 of 1 ✔</span>

<span class="go">Pulling Singularity image docker://quay.io/nextflow/rnaseq-nf:v1.0 [cache /nfs/users2/bi/lcozzuto/aaa/work/singularity/quay.io-nextflow-rnaseq-nf-v1.0.img]</span>
<span class="go">WARN: Singularity cache directory has not been defined -- Remote image will be stored in the path: /nfs/users2/bi/lcozzuto/aaa/work/singularity -- Use env  variable NXF_SINGULARITY_CACHEDIR to specify a different location</span>
<span class="go">        Done! Open the following report in your browser --&gt; results/multiqc_report.html</span>

<span class="go">Completed at: 01-Oct-2021 12:01:50</span>
<span class="go">Duration    : 3m 57s</span>
<span class="go">CPU hours   : (a few seconds)</span>
<span class="go">Succeeded   : 6</span>
</pre></div>
</div>
<p>The result from my MacBook:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">nextflow run nextflow-io/rnaseq-nf -with-docker</span>

<span class="go">N E X T F L O W  ~  version 21.04.3</span>
<span class="go">Launching `nextflow-io/rnaseq-nf` [happy_torvalds] - revision: 83bdb3199b [master]</span>
<span class="go">R N A S E Q - N F   P I P E L I N E</span>
<span class="go">===================================</span>
<span class="go">transcriptome: /Users/lcozzuto/.nextflow/assets/nextflow-io/rnaseq-nf/data/ggal/ggal_1_48850000_49020000.Ggal71.500bpflank.fa</span>
<span class="go">reads        : /Users/lcozzuto/.nextflow/assets/nextflow-io/rnaseq-nf/data/ggal/*_{1,2}.fq</span>
<span class="go">outdir       : results</span>

<span class="go">executor &gt;  local (6)</span>
<span class="go">[37/933971] process &gt; RNASEQ:INDEX (ggal_1_48850000_49020000) [100%] 1 of 1 ✔</span>
<span class="go">[fe/b06693] process &gt; RNASEQ:FASTQC (FASTQC on ggal_gut)      [100%] 2 of 2 ✔</span>
<span class="go">[73/84b898] process &gt; RNASEQ:QUANT (ggal_gut)                 [100%] 2 of 2 ✔</span>
<span class="go">[f2/917905] process &gt; MULTIQC                                 [100%] 1 of 1 ✔</span>

<span class="go">Done! Open the following report in your browser --&gt; results/multiqc_report.html</span>
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="about.html" class="btn btn-neutral float-left" title="About the course" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, CRG.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>